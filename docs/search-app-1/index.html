<<<<<<< HEAD
<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>The search app - Get Results! with Elasticsearch</title> <link rel="shortcut icon" href="https://umiamilibraries.github.io/code4lib2020-get-results-es/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="https://umiamilibraries.github.io/code4lib2020-get-results-es/assets/css/just-the-docs.css"> <script type="text/javascript" src="https://umiamilibraries.github.io/code4lib2020-get-results-es/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="https://umiamilibraries.github.io/code4lib2020-get-results-es/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>The search app | Get Results! with Elasticsearch</title> <meta name="generator" content="Jekyll v3.8.5" /> <meta property="og:title" content="The search app" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Code4Lib 2020 Workshop" /> <meta property="og:description" content="Code4Lib 2020 Workshop" /> <link rel="canonical" href="https://umiamilibraries.github.io/code4lib2020-get-results-es/search-app-1/" /> <meta property="og:url" content="https://umiamilibraries.github.io/code4lib2020-get-results-es/search-app-1/" /> <meta property="og:site_name" content="Get Results! with Elasticsearch" /> <script type="application/ld+json"> {"description":"Code4Lib 2020 Workshop","headline":"The search app","@type":"WebPage","url":"https://umiamilibraries.github.io/code4lib2020-get-results-es/search-app-1/","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="link" viewBox="0 0 16 16"> <title>Link</title> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path> </symbol> </svg> <div class="page-wrap"> <div class="side-bar"> <div class="site-header"> <a href="https://umiamilibraries.github.io/code4lib2020-get-results-es" class="site-title lh-tight"> Get Results! with Elasticsearch </a> <button class="menu-button fs-3 js-main-nav-trigger" data-text-toggle="Hide" type="button">Menu</button> </div> <div class="navigation main-nav js-main-nav"> <nav role="navigation" aria-label="Main navigation"> <ul class="navigation-list"><li class="navigation-list-item active"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/404.html" class="navigation-list-link"></a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/index.html" class="navigation-list-link">Welcome!</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/computer-setup/" class="navigation-list-link">Computer Setup</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/project-setup/" class="navigation-list-link">Project Setup</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/creating-dockerfile/" class="navigation-list-link">Creating the Dockerfile</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/docker-compose-file/" class="navigation-list-link">The docker-compose file</a></li><li class="navigation-list-item active"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/search-app-1/" class="navigation-list-link active">The search app</a></li></ul> </nav> </div> <footer class="site-footer"> <p class="text-small text-grey-dk-000 mb-4">This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</p> </footer> </div> <div class="main-content-wrap js-main-content" tabindex="0"> <div class="main-content"> <div class="page-header js-page-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search Get Results! with Elasticsearch" aria-label="Search Get Results! with Elasticsearch" autocomplete="off"> <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"><title>Search</title><g fill-rule="nonzero"><path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z"/><path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z"/></g></svg> </div> <div class="js-search-results search-results-wrap"></div> </div> </div> <div class="page"> <div id="main-content" class="page-content" role="main"> <h2 id="the-search-app"> <a href="#the-search-app" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> The search app </h2> <p> We are now ready to create our docker-compose file. Our development environment will consist of two PHP applications and a two-node Elasticsearch cluster. Let's get started. </p> <p> Let's start by defining the two-node Elasticsearch cluster. Add the following code to the docker-compose.yml file at the root of the project directory. Keep in mind this is a YAML file, so indentation matters. </p> <p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1"># docker-compose.yml</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="s">esdata-0.local</span><span class="pi">:</span> <span class="c1"># First Elasticsearch node</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">esdata-0.local</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.elastic.co/elasticsearch/elasticsearch:7.6.0</span> <span class="c1"># Official Elasticsearch image</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="c1"># Specific container environment variables</span>
      <span class="pi">-</span> <span class="s">node.name=esdata-0.local</span> <span class="c1"># Name of the Elasticsearch node</span>
      <span class="pi">-</span> <span class="s">cluster.name=es-local-cluster</span> <span class="c1"># Name of the Elasticsearch cluster</span>
      <span class="pi">-</span> <span class="s">discovery.seed_hosts=esdata-1.local</span> <span class="c1">#List of other nodes in the cluster that are likely to be live and contactable</span>
      <span class="pi">-</span> <span class="s">cluster.initial_master_nodes=esdata-0.local</span> <span class="c1"># List of other nodes in the cluster that are master eligible</span>
      <span class="pi">-</span> <span class="s">bootstrap.memory_lock=true</span> <span class="c1"># Prevents any Elasticsearch object in memory from being swapped out to the hard drive</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">ES_JAVA_OPTS=-Xms512m</span><span class="nv"> </span><span class="s">-Xmx512m"</span> <span class="c1"># Sets JVM heap size in the container</span>
    <span class="na">volumes</span><span class="pi">:</span> <span class="c1"># Attach local data directory</span>
      <span class="pi">-</span> <span class="s">esdata-0.local.data:/usr/share/elasticsearch/data</span> <span class="c1"># Docker volume to persist the node data across restarts</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">9200:9200</span> <span class="c1"># Exposing port 9200 of the container</span>
    <span class="na">ulimits</span><span class="pi">:</span>
      <span class="na">memlock</span><span class="pi">:</span> <span class="c1"># Sets an unlimited amount of memory to be locked by the service (container)</span>
        <span class="na">soft</span><span class="pi">:</span> <span class="s">-1</span>
        <span class="na">hard</span><span class="pi">:</span> <span class="s">-1</span>
=======
<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>The search app (part 1) - Get Results! with Elasticsearch</title> <link rel="shortcut icon" href="http://localhost:4000/code4lib2020-get-results-es/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="http://localhost:4000/code4lib2020-get-results-es/assets/css/just-the-docs.css"> <script type="text/javascript" src="http://localhost:4000/code4lib2020-get-results-es/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="http://localhost:4000/code4lib2020-get-results-es/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>The search app (part 1) | Get Results! with Elasticsearch</title> <meta name="generator" content="Jekyll v3.8.5" /> <meta property="og:title" content="The search app (part 1)" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Code4Lib 2020 Workshop" /> <meta property="og:description" content="Code4Lib 2020 Workshop" /> <link rel="canonical" href="http://localhost:4000/code4lib2020-get-results-es/search-app-1/" /> <meta property="og:url" content="http://localhost:4000/code4lib2020-get-results-es/search-app-1/" /> <meta property="og:site_name" content="Get Results! with Elasticsearch" /> <script type="application/ld+json"> {"@type":"WebPage","headline":"The search app (part 1)","url":"http://localhost:4000/code4lib2020-get-results-es/search-app-1/","description":"Code4Lib 2020 Workshop","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="link" viewBox="0 0 16 16"> <title>Link</title> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path> </symbol> </svg> <div class="page-wrap"> <div class="side-bar"> <div class="site-header"> <a href="http://localhost:4000/code4lib2020-get-results-es" class="site-title lh-tight"> Get Results! with Elasticsearch </a> <button class="menu-button fs-3 js-main-nav-trigger" data-text-toggle="Hide" type="button">Menu</button> </div> <div class="navigation main-nav js-main-nav"> <nav role="navigation" aria-label="Main navigation"> <ul class="navigation-list"><li class="navigation-list-item"><a href="http://localhost:4000/code4lib2020-get-results-es/index.html" class="navigation-list-link">Welcome!</a></li><li class="navigation-list-item active"><a href="http://localhost:4000/code4lib2020-get-results-es/404.html" class="navigation-list-link"></a></li><li class="navigation-list-item"><a href="http://localhost:4000/code4lib2020-get-results-es/computer-setup/" class="navigation-list-link">Computer Setup</a></li><li class="navigation-list-item"><a href="http://localhost:4000/code4lib2020-get-results-es/project-setup/" class="navigation-list-link">Project Setup</a></li><li class="navigation-list-item"><a href="http://localhost:4000/code4lib2020-get-results-es/creating-dockerfile/" class="navigation-list-link">Creating the Dockerfile</a></li><li class="navigation-list-item"><a href="http://localhost:4000/code4lib2020-get-results-es/docker-compose-file/" class="navigation-list-link">The docker-compose file</a></li><li class="navigation-list-item active"><a href="http://localhost:4000/code4lib2020-get-results-es/search-app-1/" class="navigation-list-link active">The search app (part 1)</a></li><li class="navigation-list-item"><a href="http://localhost:4000/code4lib2020-get-results-es/search-app-2/" class="navigation-list-link">The search app (part 2)</a></li></ul> </nav> </div> <footer class="site-footer"> <p class="text-small text-grey-dk-000 mb-4">This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</p> </footer> </div> <div class="main-content-wrap js-main-content" tabindex="0"> <div class="main-content"> <div class="page-header js-page-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search Get Results! with Elasticsearch" aria-label="Search Get Results! with Elasticsearch" autocomplete="off"> <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"><title>Search</title><g fill-rule="nonzero"><path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z"/><path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z"/></g></svg> </div> <div class="js-search-results search-results-wrap"></div> </div> </div> <div class="page"> <div id="main-content" class="page-content" role="main"> <h2 id="the-search-app-part-1"> <a href="#the-search-app-part-1" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> The search app (part 1) </h2> <p> In this workshop we will be working with National Screening Room collection (https://www.loc.gov/collections/national-screening-room/) from the Library of Congress. You can find more information about this collection <a href="https://www.loc.gov/collections/national-screening-room/about-this-collection/" target="_blank">here</a>. </p> <p>We will ingest data from this collection into our Elasticsearch cluster. Then, we will use our application to find items in our cluster from this collection.</p> <p>The API from the Library of Congress is still a work in progress. The Beta documentation can be found <a href="https://libraryofcongress.github.io/data-exploration/" target="_blank">here</a>. According to the documentation, we can the collection in JSON format by appending ?fo=json to the URL of the collection. </p> <p>If you open <a href="https://www.loc.gov/collections/national-screening-room/?fo=json" target="_blank">https://www.loc.gov/collections/national-screening-room/?fo=json</a> in your browser you will get the JSON of this collection.</p> <h3 id="a-custom-script-to-ingest-the-collections-data-into-the-elasticsearch-cluster"> <a href="#a-custom-script-to-ingest-the-collections-data-into-the-elasticsearch-cluster" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> A custom script to ingest the collection’s data into the Elasticsearch cluster </h3> <p>The search-app directory contains the Symfony app that will query our Elasticsearch cluster. But first, we need a way to ingest data from the Library of Congress' collection into our cluster. Let's create it!</p> <p>Navigate to /search-app/src/CustomScripts. This directory contains two files: ingest.php and ElasticsearchIngester.php. The first one will be the entry point for our script. The later is a class that will contain all the logic required for the ingestion process</p> <p>Let's check the ElasticsearchIngester class first.</p> <p>There is a couple of things happening in the class constructor: </p> <p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="c1"># search-app/src/CustomScripts/ElasticsearchIngester.php</span>
<span class="o">...</span>
<span class="kd">class</span> <span class="nc">ElasticsearchIngester</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$apiUrl</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$elasticSearchClient</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$indexName</span><span class="p">;</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$apiUrl</span><span class="p">,</span> <span class="nv">$indexName</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">apiUrl</span> <span class="o">=</span> <span class="nv">$apiUrl</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">indexName</span> <span class="o">=</span> <span class="nv">$indexName</span><span class="p">;</span>
        <span class="nv">$elastic_host_info</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nv">$_ENV</span><span class="p">[</span><span class="s1">'ELASTIC_HOST'</span><span class="p">],</span>
            <span class="nv">$_ENV</span><span class="p">[</span><span class="s1">'ELASTIC_PORT'</span><span class="p">],</span>
            <span class="nv">$_ENV</span><span class="p">[</span><span class="s1">'ELASTIC_USER'</span><span class="p">],</span>
            <span class="nv">$_ENV</span><span class="p">[</span><span class="s1">'ELASTIC_PASSWORD'</span><span class="p">]</span>
        <span class="p">];</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">elasticSearchClient</span> <span class="o">=</span> <span class="nx">ClientBuilder</span><span class="o">::</span><span class="na">create</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">setHosts</span><span class="p">(</span><span class="nv">$elastic_host_info</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">build</span><span class="p">();</span>
    <span class="p">}</span>
<span class="o">....</span>
<span class="p">}</span></code></pre></figure> </p> <p>In the class constructor we are assigning values for the apiUrl and indexName variables. We are also building an Elasticsearch client using the official PHP client for Elasticsearch. We are reading some of the Elasticsearch settings from the .env file</p> <p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="c1"># search-app/.env</span>
<span class="nx">ELASTIC_HOST</span><span class="o">=</span><span class="nx">esdata</span><span class="o">-</span><span class="mf">0.</span><span class="nx">local</span>
<span class="nx">ELASTIC_PORT</span><span class="o">=</span><span class="mi">9200</span>
<span class="nx">ELASTIC_USER</span><span class="o">=</span><span class="nx">elastic</span>
<span class="nx">ELASTIC_PASSWORD</span><span class="o">=</span><span class="nx">changeme</span></code></pre></figure> </p> <p>The ELASTIC_HOST value corresponds to the Elastisearch master node we defined in the docker-compose file. All the interactions made by the PHP client for Elasticsearch will be done using port 9200. The ELASTIC_USER and ELASTIC_PASSWORD values are the default values. IMPORTANT: These values should be changed when using Elasticsearch in a production environment</p> <p>There are also a couple of functions in the class that are responsible for getting the JSON data from the Library of Congress API, check if a specific index in Elasticseach exists and create an index in Elasticsearch.</p> <p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="c1"># search-app/src/CustomScripts/ElasticsearchIngester.php</span>
<span class="o">...</span>
<span class="k">private</span> <span class="k">function</span> <span class="nf">getJsonData</span><span class="p">(</span><span class="nv">$url</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nb">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">//We are waiting a second between each API call to prevent being temporarily banned </span>
              <span class="c1">// by the Library of Congress API</span>
    <span class="nv">$json</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$url</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">json_decode</span><span class="p">(</span><span class="nv">$json</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">indexExists</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$indexParams</span><span class="p">[</span><span class="s1">'index'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">indexName</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">elasticSearchClient</span><span class="o">-&gt;</span><span class="na">indices</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">exists</span><span class="p">(</span><span class="nv">$indexParams</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">createIndex</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$params</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">'index'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">indexName</span>
    <span class="p">];</span>
    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">elasticSearchClient</span><span class="o">-&gt;</span><span class="na">indices</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="nv">$params</span><span class="p">);</span>
<span class="p">}</span>
<span class="o">...</span></code></pre></figure> </p> <p>The ingestData() function deals with ingesting the data into the Elasticsearch cluster. The function goes through all the items in the collection and gets the id, title, location, online_format, url, notes, image_url and description of each one.</p> <p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="c1"># search-app/src/CustomScripts/ElasticsearchIngester.php</span>
<span class="o">...</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">ingestData</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nv">$progressBar</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ProgressBar</span><span class="p">(</span><span class="k">new</span> <span class="nx">ConsoleOutput</span><span class="p">(),</span> <span class="mi">100</span><span class="p">);</span>
    <span class="k">echo</span> <span class="s1">'Ingesting data'</span> <span class="o">.</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
    <span class="nv">$currentApiUrl</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">apiUrl</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getJsonData</span><span class="p">(</span><span class="nv">$currentApiUrl</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$results</span> <span class="o">=</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="na">results</span><span class="p">;</span>
            <span class="nv">$pagination</span> <span class="o">=</span> <span class="nv">$data</span><span class="o">-&gt;</span><span class="na">pagination</span><span class="p">;</span>
            <span class="nv">$params</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">prepareValues</span><span class="p">(</span><span class="nv">$results</span><span class="p">);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">elasticSearchClient</span><span class="o">-&gt;</span><span class="na">bulk</span><span class="p">(</span><span class="nv">$params</span><span class="p">);</span>
            <span class="nv">$progressBar</span><span class="o">-&gt;</span><span class="na">advance</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
            <span class="nv">$currentApiUrl</span> <span class="o">=</span> <span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$pagination</span><span class="o">-&gt;</span><span class="na">next</span><span class="p">)</span> <span class="o">?</span> <span class="nv">$pagination</span><span class="o">-&gt;</span><span class="na">next</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$currentApiUrl</span><span class="p">));</span>
    <span class="nv">$progressBar</span><span class="o">-&gt;</span><span class="na">finish</span><span class="p">();</span>
    <span class="k">echo</span> <span class="nx">PHP_EOL</span> <span class="o">.</span> <span class="s1">'Done ingesting data'</span> <span class="o">.</span> <span class="nx">PHP_EOL</span><span class="p">;</span>
<span class="p">}</span>
>>>>>>> afc-dev

<span class="k">private</span> <span class="k">function</span> <span class="nf">prepareValues</span><span class="p">(</span><span class="nv">$results</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'body'</span> <span class="o">=&gt;</span> <span class="p">[]];</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$results</span> <span class="k">as</span> <span class="nv">$result</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$params</span><span class="p">[</span><span class="s1">'body'</span><span class="p">][]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'index'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                <span class="s1">'_index'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">indexName</span><span class="p">,</span>
                <span class="s1">'_id'</span> <span class="o">=&gt;</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">id</span>
            <span class="p">]</span>
        <span class="p">];</span>
        <span class="nv">$params</span><span class="p">[</span><span class="s1">'body'</span><span class="p">][]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">title</span><span class="p">,</span>
            <span class="s1">'online_format'</span> <span class="o">=&gt;</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">online_format</span><span class="p">,</span>
            <span class="s1">'location'</span> <span class="o">=&gt;</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">location</span><span class="p">,</span>
            <span class="s1">'url'</span> <span class="o">=&gt;</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">url</span><span class="p">,</span>
            <span class="s1">'notes'</span> <span class="o">=&gt;</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">item</span><span class="o">-&gt;</span><span class="na">notes</span><span class="p">,</span>
            <span class="s1">'image_url'</span> <span class="o">=&gt;</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">image_url</span><span class="p">,</span>
            <span class="s1">'description'</span> <span class="o">=&gt;</span> <span class="nv">$result</span><span class="o">-&gt;</span><span class="na">description</span>
        <span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$params</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">...</span></code></pre></figure> </p> <p>The ingest.php file creates an instance of our ElasticsearchIngester class. Then creates an index if it does not exist and after, it ingests the collection's data into the Elasticsearch cluster</p> <p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="c1"># search-app/src/CustomScripts/ingest.php</span>
<span class="o">...</span>
<span class="nv">$apiUrl</span> <span class="o">=</span> <span class="s1">'https://www.loc.gov/collections/national-screening-room/?fo=json'</span><span class="p">;</span>

<span class="nv">$elasticSearchIngester</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ElasticsearchIngester</span><span class="p">(</span><span class="nv">$apiUrl</span><span class="p">,</span> <span class="s1">'screening-room-index'</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$elasticSearchIngester</span><span class="o">-&gt;</span><span class="na">indexExists</span><span class="p">())</span> <span class="p">{</span>
    <span class="nv">$elasticSearchIngester</span><span class="o">-&gt;</span><span class="na">createIndex</span><span class="p">();</span>
<span class="p">}</span>

<span class="nv">$elasticSearchIngester</span><span class="o">-&gt;</span><span class="na">ingestData</span><span class="p">();</span></code></pre></figure> </p> <p>Now that we are familiar with the custom script to ingest the collection's data into the Elasticsearch cluster, let's run it!</p> <h3 id="running-the-script-to-the-ingest-the-collections-data-into-the-elasticsearch-cluster"> <a href="#running-the-script-to-the-ingest-the-collections-data-into-the-elasticsearch-cluster" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Running the script to the ingest the collection’s data into the Elasticsearch cluster </h3> <p>We have to run the script from within the search-app Docker container. We are going to execute an interactive bash shell inside the container. Before executing the following code from a console, please be sure that the containers are running.</p> <p> <figure class="highlight"><pre><code class="language-docker" data-lang="docker">docker exec -it search-app bash</code></pre></figure> </p> <p>Your console should display something similar to this: </p> <p> <figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">root@19c1aaf68884:/home#</span></code></pre></figure> </p> <p>Every command we run now is executed from within the container. Let's switch to the CustomScripts directory and run the ingest.php script. Run the following two commands: </p> <hr /> <p> <figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">cd </span>site/wwwroot/src/CustomScripts/
<span class="gp">$</span><span class="w"> </span>php ingest.php</code></pre></figure> </p> <p>The output should look similar to this: </p> <p> <figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">Cannot load Zend OPcache - it was already loaded
Ingesting data
 100/100 [============================] 100%
Done ingesting data</span></code></pre></figure> </p> <p>If you visit http://localhost:9200/_search/?pretty in your browser, you should get a response from Elasticsearch with 10 items from the index we just created.</p> <p>Now we have an Elasticsearch cluster with data. Time to begin query this data from our Symfony app</p><hr /> <p><a href="/code4lib2020-get-results-es/docker-compose-file" class="btn btn-outline">Previous: The docker-compose file</a> <a href="/code4lib2020-get-results-es/search-app-2/" class="btn btn-outline">Next: The search app (part 2)</a></p> </div> </div> </div> </div> </body> </html>
