<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Creating the Dockerfile - Get Results! with Elasticsearch</title> <link rel="shortcut icon" href="http://localhost:4000/code4lib2020-get-results-es/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="http://localhost:4000/code4lib2020-get-results-es/assets/css/just-the-docs.css"> <script type="text/javascript" src="http://localhost:4000/code4lib2020-get-results-es/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="http://localhost:4000/code4lib2020-get-results-es/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>Creating the Dockerfile | Get Results! with Elasticsearch</title> <meta name="generator" content="Jekyll v3.8.5" /> <meta property="og:title" content="Creating the Dockerfile" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Code4Lib 2020 Workshop" /> <meta property="og:description" content="Code4Lib 2020 Workshop" /> <link rel="canonical" href="http://localhost:4000/code4lib2020-get-results-es/creating-dockerfile/" /> <meta property="og:url" content="http://localhost:4000/code4lib2020-get-results-es/creating-dockerfile/" /> <meta property="og:site_name" content="Get Results! with Elasticsearch" /> <script type="application/ld+json"> {"@type":"WebPage","headline":"Creating the Dockerfile","url":"http://localhost:4000/code4lib2020-get-results-es/creating-dockerfile/","description":"Code4Lib 2020 Workshop","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="link" viewBox="0 0 16 16"> <title>Link</title> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path> </symbol> </svg> <div class="page-wrap"> <div class="side-bar"> <div class="site-header"> <a href="http://localhost:4000/code4lib2020-get-results-es" class="site-title lh-tight"> Get Results! with Elasticsearch </a> <button class="menu-button fs-3 js-main-nav-trigger" data-text-toggle="Hide" type="button">Menu</button> </div> <div class="navigation main-nav js-main-nav"> <nav role="navigation" aria-label="Main navigation"> <ul class="navigation-list"><li class="navigation-list-item"><a href="http://localhost:4000/code4lib2020-get-results-es/index.html" class="navigation-list-link">Welcome!</a></li><li class="navigation-list-item active"><a href="http://localhost:4000/code4lib2020-get-results-es/404.html" class="navigation-list-link"></a></li><li class="navigation-list-item"><a href="http://localhost:4000/code4lib2020-get-results-es/computer-setup/" class="navigation-list-link">Computer Setup</a></li><li class="navigation-list-item"><a href="http://localhost:4000/code4lib2020-get-results-es/project-setup/" class="navigation-list-link">Project Setup</a></li><li class="navigation-list-item active"><a href="http://localhost:4000/code4lib2020-get-results-es/creating-dockerfile/" class="navigation-list-link active">Creating the Dockerfile</a></li><li class="navigation-list-item"><a href="http://localhost:4000/code4lib2020-get-results-es/docker-compose-file/" class="navigation-list-link">The docker-compose file</a></li></ul> </nav> </div> <footer class="site-footer"> <p class="text-small text-grey-dk-000 mb-4">This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</p> </footer> </div> <div class="main-content-wrap js-main-content" tabindex="0"> <div class="main-content"> <div class="page-header js-page-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search Get Results! with Elasticsearch" aria-label="Search Get Results! with Elasticsearch" autocomplete="off"> <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"><title>Search</title><g fill-rule="nonzero"><path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z"/><path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z"/></g></svg> </div> <div class="js-search-results search-results-wrap"></div> </div> </div> <div class="page"> <div id="main-content" class="page-content" role="main"> <h2 id="creating-the-dockerfile"> <a href="#creating-the-dockerfile" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Creating the Dockerfile </h2> <p>A Dockerfile contains all the commands needed to build a specific image. Think off a Dockerfile as a recipe to build an image.</p> <p>Docker images are formed by multiple read-only layers that are representations of the instructions contained in the Dockerfile. Each layer builds on top of the previous layer.</p> <p>Let's create a new file named Dockerfile in the .docker directory and add the following code to it.</p> <p> <figure class="highlight"><pre><code class="language-docker" data-lang="docker"><span class="c">#.docker/Dockerfile</span>

<span class="k">FROM</span><span class="s"> appsvc/php:7.3-apache_20200101.1</span></code></pre></figure> </p> <p>We are instructing Docker to start FROM the pre-existing PHP and Apache image built by Microsoft, appsvc/php:7.3-apache_20200101.1. This pre-existing image is running a Linux distribution and php version 7.3 and apache, and it was created on January 1st, 2020.</p> <p>Now, let's install php composer. Add the following code to the Dockerfile.</p> <p> <figure class="highlight"><pre><code class="language-docker" data-lang="docker"><span class="c">#.docker/Dockerfile</span>

<span class="c"># Installing php composer</span>
<span class="k">RUN </span>curl <span class="nt">-sS</span> https://getcomposer.org/installer | php
<span class="k">RUN </span><span class="nb">mv </span>composer.phar /usr/local/bin/composer <span class="o">&amp;&amp;</span> <span class="se">\
</span>        <span class="nb">chmod</span> +x /usr/local/bin/composer <span class="o">&amp;&amp;</span> <span class="se">\
</span>        composer <span class="nt">--version</span></code></pre></figure> </p> <p>The pre-existing image that we are using comes with PHP Opcache enabled. This extension helps to improve PHP performance by caching scripts in memory. However, since we are going to be using this container for development purposes, we want to disable caching for now. In order to do that, let's insert the following code into our Dockerfile.</p> <p> <figure class="highlight"><pre><code class="language-docker" data-lang="docker"><span class="c">#.docker/Dockerfile</span>

<span class="c">#Remove php opcache file -- only for development</span>
<span class="k">RUN </span><span class="nb">rm</span> <span class="nt">-rf</span> /usr/local/etc/php/conf.d/opcache-recommended.ini</code></pre></figure> </p> <h3 id="synchronizing-spin-up-of-independent-containers"> <a href="#synchronizing-spin-up-of-independent-containers" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Synchronizing spin-up of independent containers </h3> <p> In this workshop we are going to have multiple containers running at the same time. However, we might run into a scenario where our development container depends on another container to work, and not only another container, but also the services running inside this other container to be up and running. </p> <p> To address this problem, we are going to use <a href="https://github.com/vishnubob/wait-for-it">wait-for-it</a>, a bash script that will make our development container wait for any other container it depends on to continue. Add the following code to your Dockerfile: </p> <p> <figure class="highlight"><pre><code class="language-docker" data-lang="docker"><span class="c">#.docker/Dockerfile</span>

<span class="k">COPY</span><span class="s"> ./wait-for-it/wait-for-it.sh /usr/local/wait-for-it.sh</span>
<span class="k">RUN </span><span class="nb">chmod </span>u+x /usr/local/wait-for-it.sh</code></pre></figure> </p> <h3 id="adding-an-entrypoint-to-the-dockerfile"> <a href="#adding-an-entrypoint-to-the-dockerfile" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Adding an ENTRYPOINT to the Dockerfile </h3> <p> An ENTRYPOINT will let us specify which commands we want to execute when the container is started. Let's, for now, add the following code to our Dockerfile </p> <p> <figure class="highlight"><pre><code class="language-docker" data-lang="docker"><span class="c">#.docker/Dockerfile</span>

<span class="k">COPY</span><span class="s"> ./.docker/init.sh /usr/local/bin/init.sh</span>
<span class="k">RUN </span><span class="nb">chmod </span>u+x /usr/local/bin/init.sh

<span class="k">ENTRYPOINT</span><span class="s"> ["/usr/local/bin/init.sh"]</span></code></pre></figure> </p> <p> The previous code will copy the init.sh file into the Docker container and define an ENTRYPOINT using the init.sh But wait, the init.sh file does not exist. Let's create an init.sh file in the .docker directory and add the following code to it: </p> <p> <figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/usr/bin/env bash</span>

<span class="nb">echo</span> <span class="s2">"Checking Elasticsearch node 1 is ready"</span>
/usr/local/wait-for-it.sh esdata-0.local:9200 <span class="nt">-s</span> <span class="nt">--timeout</span><span class="o">=</span>120 <span class="nt">--</span> <span class="nb">echo</span> <span class="s2">"Node 1 is ready!"</span>

<span class="nb">echo</span> <span class="s2">"Checking Elasticsearch node 2 is ready"</span>
/usr/local/wait-for-it.sh esdata-1.local:9200 <span class="nt">-s</span> <span class="nt">--timeout</span><span class="o">=</span>120 <span class="nt">--</span> <span class="nb">echo</span> <span class="s2">"Node 2 is ready!"</span>

<span class="c"># start apache</span>
/usr/sbin/apache2ctl <span class="nt">-D</span> FOREGROUND</code></pre></figure> </p> <p>This code will wait 2 minutes for the Elasticsearch containers (we will create these in a later section) to be ready and then starts up the Apache server listening on port 80.</p> <p>The Dockerfile should look like this at this point:</p> <p> <figure class="highlight"><pre><code class="language-docker" data-lang="docker"><span class="k">FROM</span><span class="s"> appsvc/php:7.3-apache_20200101.1</span>

<span class="c"># Installing php composer</span>
<span class="k">RUN </span>curl <span class="nt">-sS</span> https://getcomposer.org/installer | php
<span class="k">RUN </span><span class="nb">mv </span>composer.phar /usr/local/bin/composer <span class="o">&amp;&amp;</span> <span class="se">\
</span>        <span class="nb">chmod</span> +x /usr/local/bin/composer <span class="o">&amp;&amp;</span> <span class="se">\
</span>        composer <span class="nt">--version</span>

<span class="c">#Remove php opcache file -- only for development</span>
<span class="k">RUN </span><span class="nb">rm</span> <span class="nt">-rf</span> /usr/local/etc/php/conf.d/opcache-recommended.ini

<span class="k">COPY</span><span class="s"> ./.docker/wait-for-it/wait-for-it.sh /usr/local/wait-for-it.sh</span>
<span class="k">RUN </span><span class="nb">chmod </span>u+x /usr/local/wait-for-it.sh

<span class="k">COPY</span><span class="s"> ./.docker/init.sh /usr/local/bin/init.sh</span>
<span class="k">RUN </span><span class="nb">chmod </span>u+x /usr/local/bin/init.sh

<span class="k">ENTRYPOINT</span><span class="s"> ["/usr/local/bin/init.sh"]</span></code></pre></figure> </p> <p>Time to build the container. Run the following code from the project root folder in a console:</p> <p> <figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span>docker build <span class="nt">-f</span> .docker/Dockerfile .</code></pre></figure> </p> <p>The previous command tells Docker to build a container using the Dockerfile defined in the -f parameter. I f you don't specify a filepath, Docker will search for a Dockefile within the same directory the build command is executed from. The dot at the end of the command specified the location where we want to build the container. In this case, we are building the container in the current directory</p> <p>The output from the previous docker build command should look similar to this: </p> <p> <figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">Sending build context to Docker daemon  286.2kB
Step 1/7 : FROM appsvc/php:7.2-apache_20191031.7
</span><span class="gp"> ---&gt;</span><span class="w"> </span>692faef99277
<span class="go">Step 2/7 : RUN curl -sS https://getcomposer.org/installer | php
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Running <span class="k">in </span>59de52d7babe
<span class="go">Cannot load Zend OPcache - it was already loaded
All settings correct for using Composer
Downloading...

Composer (version 1.9.3) successfully installed to: /home/site/wwwroot/composer.phar
Use it: php composer.phar

Removing intermediate container 59de52d7babe
</span><span class="gp"> ---&gt;</span><span class="w"> </span>11c9d3ca3665
<span class="go">Step 3/7 : RUN mv composer.phar /usr/local/bin/composer &amp;&amp; chmod +x /usr/local/bin/composer &amp;&amp; composer --version
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Running <span class="k">in </span>ea691c6d9ec2
<span class="go">Cannot load Zend OPcache - it was already loaded
Composer version 1.9.3 2020-02-04 12:58:49
Removing intermediate container ea691c6d9ec2
</span><span class="gp"> ---&gt;</span><span class="w"> </span>220bcb9bfeb3
<span class="go">Step 4/7 : RUN rm -rf /usr/local/etc/php/conf.d/opcache-recommended.ini
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Running <span class="k">in </span>5b0c82733c56
<span class="go">Removing intermediate container 5b0c82733c56
</span><span class="gp"> ---&gt;</span><span class="w"> </span>8bb2be6b4690
<span class="go">Step 5/7 : COPY ./.docker/init.sh /usr/local/bin/init.sh
</span><span class="gp"> ---&gt;</span><span class="w"> </span>51ac59253e84
<span class="go">Step 6/7 : RUN chmod u+x /usr/local/bin/init.sh
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Running <span class="k">in </span>78fd768bc949
<span class="go">Removing intermediate container 78fd768bc949
</span><span class="gp"> ---&gt;</span><span class="w"> </span>f0db0655f565
<span class="go">Step 7/7 : ENTRYPOINT ["/usr/local/bin/init.sh"]
</span><span class="gp"> ---&gt;</span><span class="w"> </span>Running <span class="k">in </span>5d6b187e36c2
<span class="go">Removing intermediate container 5d6b187e36c2
</span><span class="gp"> ---&gt;</span><span class="w"> </span>67a994a34f76
<span class="go">Successfully built 67a994a34f76</span></code></pre></figure> </p> <p> So far we have written a Dockerfile to build a Docker container running PHP, Apache, php-composer and a custom ENTRYPOINT. In the next sections, we will create a docker-compose file to configure other containers that we need for our search application. </p> <hr /> <p><a href="/code4lib2020-get-results-es/project-setup" class="btn btn-outline">Previous: Project Setup</a> <a href="/code4lib2020-get-results-es/docker-compose-file/" class="btn btn-outline">Next: The docker-compose file</a></p> </div> </div> </div> </div> </body> </html>
