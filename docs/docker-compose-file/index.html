<<<<<<< HEAD
<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>The docker-compose file - Get Results! with Elasticsearch</title> <link rel="shortcut icon" href="https://umiamilibraries.github.io/code4lib2020-get-results-es/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="https://umiamilibraries.github.io/code4lib2020-get-results-es/assets/css/just-the-docs.css"> <script type="text/javascript" src="https://umiamilibraries.github.io/code4lib2020-get-results-es/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="https://umiamilibraries.github.io/code4lib2020-get-results-es/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>The docker-compose file | Get Results! with Elasticsearch</title> <meta name="generator" content="Jekyll v3.8.5" /> <meta property="og:title" content="The docker-compose file" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Code4Lib 2020 Workshop" /> <meta property="og:description" content="Code4Lib 2020 Workshop" /> <link rel="canonical" href="https://umiamilibraries.github.io/code4lib2020-get-results-es/docker-compose-file/" /> <meta property="og:url" content="https://umiamilibraries.github.io/code4lib2020-get-results-es/docker-compose-file/" /> <meta property="og:site_name" content="Get Results! with Elasticsearch" /> <script type="application/ld+json"> {"description":"Code4Lib 2020 Workshop","headline":"The docker-compose file","@type":"WebPage","url":"https://umiamilibraries.github.io/code4lib2020-get-results-es/docker-compose-file/","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="link" viewBox="0 0 16 16"> <title>Link</title> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path> </symbol> </svg> <div class="page-wrap"> <div class="side-bar"> <div class="site-header"> <a href="https://umiamilibraries.github.io/code4lib2020-get-results-es" class="site-title lh-tight"> Get Results! with Elasticsearch </a> <button class="menu-button fs-3 js-main-nav-trigger" data-text-toggle="Hide" type="button">Menu</button> </div> <div class="navigation main-nav js-main-nav"> <nav role="navigation" aria-label="Main navigation"> <ul class="navigation-list"><li class="navigation-list-item active"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/404.html" class="navigation-list-link"></a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/index.html" class="navigation-list-link">Welcome!</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/computer-setup/" class="navigation-list-link">Computer Setup</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/project-setup/" class="navigation-list-link">Project Setup</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/creating-dockerfile/" class="navigation-list-link">Creating the Dockerfile</a></li><li class="navigation-list-item active"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/docker-compose-file/" class="navigation-list-link active">The docker-compose file</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/search-app-1/" class="navigation-list-link">The search app</a></li></ul> </nav> </div> <footer class="site-footer"> <p class="text-small text-grey-dk-000 mb-4">This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</p> </footer> </div> <div class="main-content-wrap js-main-content" tabindex="0"> <div class="main-content"> <div class="page-header js-page-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search Get Results! with Elasticsearch" aria-label="Search Get Results! with Elasticsearch" autocomplete="off"> <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"><title>Search</title><g fill-rule="nonzero"><path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z"/><path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z"/></g></svg> </div> <div class="js-search-results search-results-wrap"></div> </div> </div> <div class="page"> <div id="main-content" class="page-content" role="main"> <h2 id="the-docker-compose-file"> <a href="#the-docker-compose-file" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> The docker-compose file </h2> <p> We are now ready to create our docker-compose file. Our development environment will consist of two PHP applications and a two-node Elasticsearch cluster. Let's get started. </p> <p> Let's start by defining the two-node Elasticsearch cluster. Add the following code to the docker-compose.yml file at the root of the project directory. Keep in mind this is a YAML file, so indentation matters. </p> <p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1"># docker-compose.yml</span>
=======
<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>The docker-compose file - Get Results! with Elasticsearch</title> <link rel="shortcut icon" href="http://localhost:4000/code4lib2020-get-results-es/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="http://localhost:4000/code4lib2020-get-results-es/assets/css/just-the-docs.css"> <script type="text/javascript" src="http://localhost:4000/code4lib2020-get-results-es/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="http://localhost:4000/code4lib2020-get-results-es/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>The docker-compose file | Get Results! with Elasticsearch</title> <meta name="generator" content="Jekyll v3.8.5" /> <meta property="og:title" content="The docker-compose file" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Code4Lib 2020 Workshop" /> <meta property="og:description" content="Code4Lib 2020 Workshop" /> <link rel="canonical" href="http://localhost:4000/code4lib2020-get-results-es/docker-compose-file/" /> <meta property="og:url" content="http://localhost:4000/code4lib2020-get-results-es/docker-compose-file/" /> <meta property="og:site_name" content="Get Results! with Elasticsearch" /> <script type="application/ld+json"> {"@type":"WebPage","headline":"The docker-compose file","url":"http://localhost:4000/code4lib2020-get-results-es/docker-compose-file/","description":"Code4Lib 2020 Workshop","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="link" viewBox="0 0 16 16"> <title>Link</title> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path> </symbol> </svg> <div class="page-wrap"> <div class="side-bar"> <div class="site-header"> <a href="http://localhost:4000/code4lib2020-get-results-es" class="site-title lh-tight"> Get Results! with Elasticsearch </a> <button class="menu-button fs-3 js-main-nav-trigger" data-text-toggle="Hide" type="button">Menu</button> </div> <div class="navigation main-nav js-main-nav"> <nav role="navigation" aria-label="Main navigation"> <ul class="navigation-list"><li class="navigation-list-item"><a href="http://localhost:4000/code4lib2020-get-results-es/index.html" class="navigation-list-link">Welcome!</a></li><li class="navigation-list-item active"><a href="http://localhost:4000/code4lib2020-get-results-es/404.html" class="navigation-list-link"></a></li><li class="navigation-list-item"><a href="http://localhost:4000/code4lib2020-get-results-es/computer-setup/" class="navigation-list-link">Computer Setup</a></li><li class="navigation-list-item"><a href="http://localhost:4000/code4lib2020-get-results-es/project-setup/" class="navigation-list-link">Project Setup</a></li><li class="navigation-list-item"><a href="http://localhost:4000/code4lib2020-get-results-es/creating-dockerfile/" class="navigation-list-link">Creating the Dockerfile</a></li><li class="navigation-list-item active"><a href="http://localhost:4000/code4lib2020-get-results-es/docker-compose-file/" class="navigation-list-link active">The docker-compose file</a></li><li class="navigation-list-item"><a href="http://localhost:4000/code4lib2020-get-results-es/search-app-1/" class="navigation-list-link">The search app (part 1)</a></li><li class="navigation-list-item"><a href="http://localhost:4000/code4lib2020-get-results-es/search-app-2/" class="navigation-list-link">The search app (part 2)</a></li></ul> </nav> </div> <footer class="site-footer"> <p class="text-small text-grey-dk-000 mb-4">This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</p> </footer> </div> <div class="main-content-wrap js-main-content" tabindex="0"> <div class="main-content"> <div class="page-header js-page-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search Get Results! with Elasticsearch" aria-label="Search Get Results! with Elasticsearch" autocomplete="off"> <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"><title>Search</title><g fill-rule="nonzero"><path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z"/><path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z"/></g></svg> </div> <div class="js-search-results search-results-wrap"></div> </div> </div> <div class="page"> <div id="main-content" class="page-content" role="main"> <h2 id="the-docker-compose-file"> <a href="#the-docker-compose-file" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> The docker-compose file </h2> <p> We are now ready to create our docker-compose file. Our development environment will consist of two PHP applications and a two-node Elasticsearch cluster. Let's get started. </p> <p> Let's start by defining the two-node Elasticsearch cluster. Add the following code to the docker-compose.yml file at the root of the project directory. Keep in mind this is a YAML file, so indentation matters. </p> <p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1"># docker-compose.yml</span>
>>>>>>> afc-dev
<span class="na">services</span><span class="pi">:</span>
  <span class="s">esdata-0.local</span><span class="pi">:</span> <span class="c1"># First Elasticsearch node</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">esdata-0.local</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.elastic.co/elasticsearch/elasticsearch:7.6.0</span> <span class="c1"># Official Elasticsearch image</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="c1"># Specific container environment variables</span>
      <span class="pi">-</span> <span class="s">node.name=esdata-0.local</span> <span class="c1"># Name of the Elasticsearch node</span>
      <span class="pi">-</span> <span class="s">cluster.name=es-local-cluster</span> <span class="c1"># Name of the Elasticsearch cluster</span>
      <span class="pi">-</span> <span class="s">discovery.seed_hosts=esdata-1.local</span> <span class="c1">#List of other nodes in the cluster that are likely to be live and contactable</span>
      <span class="pi">-</span> <span class="s">cluster.initial_master_nodes=esdata-0.local</span> <span class="c1"># List of other nodes in the cluster that are master eligible</span>
      <span class="pi">-</span> <span class="s">bootstrap.memory_lock=true</span> <span class="c1"># Prevents any Elasticsearch object in memory from being swapped out to the hard drive</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">ES_JAVA_OPTS=-Xms512m</span><span class="nv"> </span><span class="s">-Xmx512m"</span> <span class="c1"># Sets JVM heap size in the container</span>
    <span class="na">volumes</span><span class="pi">:</span> <span class="c1"># Attach local data directory</span>
      <span class="pi">-</span> <span class="s">esdata-0.local.data:/usr/share/elasticsearch/data</span> <span class="c1"># Docker volume to persist the node data across restarts</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">9200:9200</span> <span class="c1"># Exposing port 9200 of the container</span>
    <span class="na">ulimits</span><span class="pi">:</span>
      <span class="na">memlock</span><span class="pi">:</span> <span class="c1"># Sets an unlimited amount of memory to be locked by the service (container)</span>
        <span class="na">soft</span><span class="pi">:</span> <span class="s">-1</span>
        <span class="na">hard</span><span class="pi">:</span> <span class="s">-1</span>

  <span class="s">esdata-1.local</span><span class="pi">:</span> <span class="c1"># Second Elasticsearch node</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">esdata-1.local</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.elastic.co/elasticsearch/elasticsearch:7.6.0</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">node.name=esdata-1.local</span>
      <span class="pi">-</span> <span class="s">cluster.name=es-local-cluster</span>
      <span class="pi">-</span> <span class="s">discovery.seed_hosts=esdata-0.local</span>
      <span class="pi">-</span> <span class="s">cluster.initial_master_nodes=esdata-0.local</span>
      <span class="pi">-</span> <span class="s">bootstrap.memory_lock=true</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">ES_JAVA_OPTS=-Xms512m</span><span class="nv"> </span><span class="s">-Xmx512m"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">esdata-1.local.data:/usr/share/elasticsearch/data</span>
    <span class="na">ulimits</span><span class="pi">:</span>
      <span class="na">memlock</span><span class="pi">:</span>
        <span class="na">soft</span><span class="pi">:</span> <span class="s">-1</span>
        <span class="na">hard</span><span class="pi">:</span> <span class="s">-1</span>

<span class="na">volumes</span><span class="pi">:</span> <span class="c1"># Defines volumes used by the services</span>
  <span class="s">esdata-0.local.data</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">local</span>
  <span class="s">esdata-1.local.data</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">local</span></code></pre></figure> </p> <p> Let's run our cluster with Docker-Compose. Run the following command in a console in the same directory where the docker-compose file is located. </p> <p> <figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span>docker-compose up</code></pre></figure> </p> <p> Docker-Compose will pull the Elasticsearch v7.6.0 image and start the two services we defined. This operation can take a few minutes depending on the host computer hardware. </p> <p> Let's check if the cluster is running. Open a browser and visit the URL http://localhost:9200/_nodes/stats </p> <p> We are querying the Nodes stats API of Elasticsearch. The response should look similar to this (nodes details collapsed on purpose): </p> <p> <figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="p">{</span><span class="w">
    </span><span class="nl">"_nodes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
        </span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
        </span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"cluster_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"es-local-cluster"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"nodes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"BkODnEDlS4mjSh4tg6NeTA"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="err">items</span><span class="w">
        </span><span class="nl">"TTTdcluiRrSao-9vFdSpvQ"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="err">items</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure> </p> <p> Go back to the console from where you ran the docker-compose up command and press Ctrl+C to stop the containers. </p> <p> So far we have defined a two-node Elasticsearch cluster. These two nodes (containers) are using the official image of Elasticsearch v7.6.0 and are part of the es-local-cluster cluster. We also defined two volumes to be used by each node, so the node data is persisted across restarts of the container. </p> <h3 id="adding-a-service-for-our-custom-app"> <a href="#adding-a-service-for-our-custom-app" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Adding a service for our custom app </h3> <p> Now we have a working Elasticsearch cluster. It is time to define the other service that will run the custom app we are going to create. </p> <p> Add the below service in the docker-compose file, after the second Elasticsearch service. </p> <p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1"># docker-compose.yml</span>

  <span class="na">search-app</span><span class="pi">:</span> <span class="c1"># Search App service</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">search-app</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">context</span><span class="pi">:</span> <span class="s">./</span>
      <span class="na">dockerfile</span><span class="pi">:</span> <span class="s">./.docker/Dockerfile</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="c1"># Specific container environment variables</span>
      <span class="pi">-</span> <span class="s">APACHE_PORT=80</span> <span class="c1"># Set Apache to listen on port 80</span>
      <span class="pi">-</span> <span class="s">APACHE_DOCUMENT_ROOT=/home/site/wwwroot/public</span> <span class="c1">#Set the directory from which Apache will serve files</span>
    <span class="na">volumes</span><span class="pi">:</span> <span class="c1"># Attach local data directory</span>
      <span class="pi">-</span> <span class="s">./search-app:/home/site/wwwroot</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">esdata-0.local</span>
      <span class="pi">-</span> <span class="s">esdata-1.local</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">8080:80</span></code></pre></figure> </p> <p>Run docker-compose up again and visit http://localhost:8080/public/ in your browser. You should get the following: </p> <p> <figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span>docker-compose up</code></pre></figure> </p> <p> <figure> <img src="/code4lib2020-get-results-es/assets/images/search-app-running-from-docker-container.png" alt="Image displays Search app running on the Docker Container" /> </figure> </p> <p>Your docker-compose file should look like these now: </p> <p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1">#docker-compose.yml</span>

<span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.6'</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="s">esdata-0.local</span><span class="pi">:</span> <span class="c1"># First Elasticsearch node</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">esdata-0.local</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.elastic.co/elasticsearch/elasticsearch:7.6.0</span> <span class="c1"># Official Elasticsearch image</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="c1"># Specific container environment variables</span>
      <span class="pi">-</span> <span class="s">node.name=esdata-0.local</span> <span class="c1"># Name of the Elasticsearch node</span>
      <span class="pi">-</span> <span class="s">cluster.name=es-local-cluster</span> <span class="c1"># Name of the Elasticsearch cluster</span>
      <span class="pi">-</span> <span class="s">discovery.seed_hosts=esdata-1.local</span> <span class="c1">#List of other nodes in the cluster that are likely to be live and contactable</span>
      <span class="pi">-</span> <span class="s">cluster.initial_master_nodes=esdata-0.local</span> <span class="c1"># List of other nodes in the cluster that are master eligible</span>
      <span class="pi">-</span> <span class="s">bootstrap.memory_lock=true</span> <span class="c1"># Prevents any Elasticsearch object in memory from being swapped out to the hard drive</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">ES_JAVA_OPTS=-Xms512m</span><span class="nv"> </span><span class="s">-Xmx512m"</span> <span class="c1"># Sets JVM heap size in the container</span>
    <span class="na">volumes</span><span class="pi">:</span> <span class="c1"># Attach local data directory</span>
      <span class="pi">-</span> <span class="s">esdata-0.local.data:/usr/share/elasticsearch/data</span> <span class="c1"># Docker volume to persist the node data across restarts</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">9200:9200</span> <span class="c1"># Exposing port 9200 of the container</span>
    <span class="na">ulimits</span><span class="pi">:</span>
      <span class="na">memlock</span><span class="pi">:</span> <span class="c1"># Sets an unlimited amount of memory to be locked by the service (container)</span>
        <span class="na">soft</span><span class="pi">:</span> <span class="s">-1</span>
        <span class="na">hard</span><span class="pi">:</span> <span class="s">-1</span>

  <span class="s">esdata-1.local</span><span class="pi">:</span> <span class="c1"># Second Elasticsearch node</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">esdata-1.local</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">docker.elastic.co/elasticsearch/elasticsearch:7.6.0</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">node.name=esdata-1.local</span>
      <span class="pi">-</span> <span class="s">cluster.name=es-local-cluster</span>
      <span class="pi">-</span> <span class="s">discovery.seed_hosts=esdata-0.local</span>
      <span class="pi">-</span> <span class="s">cluster.initial_master_nodes=esdata-0.local</span>
      <span class="pi">-</span> <span class="s">bootstrap.memory_lock=true</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">ES_JAVA_OPTS=-Xms512m</span><span class="nv"> </span><span class="s">-Xmx512m"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">esdata-1.local.data:/usr/share/elasticsearch/data</span>
    <span class="na">ulimits</span><span class="pi">:</span>
      <span class="na">memlock</span><span class="pi">:</span>
        <span class="na">soft</span><span class="pi">:</span> <span class="s">-1</span>
        <span class="na">hard</span><span class="pi">:</span> <span class="s">-1</span>

  <span class="na">search-app</span><span class="pi">:</span> <span class="c1"># Search App service</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">search-app</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">context</span><span class="pi">:</span> <span class="s">./</span>
      <span class="na">dockerfile</span><span class="pi">:</span> <span class="s">./.docker/Dockerfile</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="c1"># Specific container environment variables</span>
      <span class="pi">-</span> <span class="s">APACHE_PORT=80</span> <span class="c1"># Set Apache to listen on port 80</span>
      <span class="pi">-</span> <span class="s">APACHE_DOCUMENT_ROOT=/home/site/wwwroot/public</span> <span class="c1">#Set the directory from which Apache will serve files</span>
    <span class="na">volumes</span><span class="pi">:</span> <span class="c1"># Attach local data directory</span>
      <span class="pi">-</span> <span class="s">./search-app:/home/site/wwwroot</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">esdata-0.local</span>
      <span class="pi">-</span> <span class="s">esdata-1.local</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">8080:80</span>

<span class="na">volumes</span><span class="pi">:</span> <span class="c1"># Defines volumes used by the services</span>
  <span class="s">esdata-0.local.data</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">local</span>
  <span class="s">esdata-1.local.data</span><span class="pi">:</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">local</span></code></pre></figure> </p> <p>We now have in place all the infrastructure for our search app. Let's create the search app!</p> <hr /> <p><a href="/code4lib2020-get-results-es/creating-dockerfile" class="btn btn-outline">Previous: Creating the Dockerfile</a> <a href="/code4lib2020-get-results-es/search-app-1/" class="btn btn-outline">Next: The search app (part 1)</a></p> </div> </div> </div> </div> </body> </html>
