<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>The search app (part 2) - Get Results! with Elasticsearch</title> <link rel="shortcut icon" href="https://umiamilibraries.github.io/code4lib2020-get-results-es/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="https://umiamilibraries.github.io/code4lib2020-get-results-es/assets/css/just-the-docs.css"> <script type="text/javascript" src="https://umiamilibraries.github.io/code4lib2020-get-results-es/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="https://umiamilibraries.github.io/code4lib2020-get-results-es/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>The search app (part 2) | Get Results! with Elasticsearch</title> <meta name="generator" content="Jekyll v3.8.5" /> <meta property="og:title" content="The search app (part 2)" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Code4Lib 2020 Workshop" /> <meta property="og:description" content="Code4Lib 2020 Workshop" /> <link rel="canonical" href="https://umiamilibraries.github.io/code4lib2020-get-results-es/search-app-2/" /> <meta property="og:url" content="https://umiamilibraries.github.io/code4lib2020-get-results-es/search-app-2/" /> <meta property="og:site_name" content="Get Results! with Elasticsearch" /> <script type="application/ld+json"> {"@type":"WebPage","headline":"The search app (part 2)","url":"https://umiamilibraries.github.io/code4lib2020-get-results-es/search-app-2/","description":"Code4Lib 2020 Workshop","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="link" viewBox="0 0 16 16"> <title>Link</title> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path> </symbol> </svg> <div class="page-wrap"> <div class="side-bar"> <div class="site-header"> <a href="https://umiamilibraries.github.io/code4lib2020-get-results-es" class="site-title lh-tight"> Get Results! with Elasticsearch </a> <button class="menu-button fs-3 js-main-nav-trigger" data-text-toggle="Hide" type="button">Menu</button> </div> <div class="navigation main-nav js-main-nav"> <nav role="navigation" aria-label="Main navigation"> <ul class="navigation-list"><li class="navigation-list-item active"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/404.html" class="navigation-list-link"></a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/index.html" class="navigation-list-link">Welcome!</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/computer-setup/" class="navigation-list-link">Computer Setup</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/project-setup/" class="navigation-list-link">Project Setup</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/creating-dockerfile/" class="navigation-list-link">Creating the Dockerfile</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/docker-compose-file/" class="navigation-list-link">The docker-compose file</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/search-app-1/" class="navigation-list-link">The search app (part 1)</a></li><li class="navigation-list-item active"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/search-app-2/" class="navigation-list-link active">The search app (part 2)</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/searching-multiple-indexes/" class="navigation-list-link">Searching multiple indexes</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/dev-tools-console/" class="navigation-list-link">The Dev Tools Console</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/useful-links/" class="navigation-list-link">Useful links</a></li></ul> </nav> </div> <footer class="site-footer"> <p class="text-small text-grey-dk-000 mb-4">This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</p> </footer> </div> <div class="main-content-wrap js-main-content" tabindex="0"> <div class="main-content"> <div class="page-header js-page-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search Get Results! with Elasticsearch" aria-label="Search Get Results! with Elasticsearch" autocomplete="off"> <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"><title>Search</title><g fill-rule="nonzero"><path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z"/><path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z"/></g></svg> </div> <div class="js-search-results search-results-wrap"></div> </div> </div> <div class="page"> <div id="main-content" class="page-content" role="main"> <h2 id="the-search-app-part-2"> <a href="#the-search-app-part-2" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> The search app (part 2) </h2> <p>Let's start by defining the SearchController in our Symfony app</p> <p>The SearchController class currently have a defined route for the root URL of our application. This route calls the index() function which returns a twig template. We get this when visiting the following URL http://localhost:8080/public/</p> <p> <figure> <img src="/code4lib2020-get-results-es/assets/images/search-app-running-from-docker-container.png" alt="Image displays Search app running on the Docker Container" /> </figure> </p> <p>Let's modify the controller class so we can do a search. Replace the index() function with the following one. Be sure to import all the required classes.</p> <p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="c1"># search-app/src/Controller/SearchController.php</span>
    <span class="cd">/**
     * @Route("/")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">index</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$searchTerm</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">query</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'query'</span><span class="p">);</span>
        <span class="nv">$searchResults</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$searchTerm</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$queryResponse</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">doSearch</span><span class="p">(</span><span class="nv">$searchTerm</span><span class="p">);</span>
            <span class="nv">$searchResults</span> <span class="o">=</span> <span class="nv">$queryResponse</span><span class="p">[</span><span class="s1">'hits'</span><span class="p">][</span><span class="s1">'hits'</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">'search-app.html.twig'</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'searchTerm'</span> <span class="o">=&gt;</span> <span class="nv">$searchTerm</span><span class="p">,</span>
            <span class="s1">'searchResults'</span> <span class="o">=&gt;</span> <span class="nv">$searchResults</span>
        <span class="p">]);</span>
    <span class="p">}</span></code></pre></figure> </p> <p>The index() function will render a twig template with the results from our query. We need to define the doSearch() auxiliary function that is being called from the index() function. Add the following code below the index() function: </p> <p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="c1"># search-app/src/Controller/SearchController.php</span>
    <span class="k">private</span> <span class="k">function</span> <span class="nf">doSearch</span><span class="p">(</span><span class="nv">$searchTerm</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$elastic_host_info</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nv">$_ENV</span><span class="p">[</span><span class="s1">'ELASTIC_HOST'</span><span class="p">],</span>
            <span class="nv">$_ENV</span><span class="p">[</span><span class="s1">'ELASTIC_PORT'</span><span class="p">]</span>
        <span class="p">];</span>

        <span class="nv">$elasticSearchClient</span> <span class="o">=</span> <span class="nx">ClientBuilder</span><span class="o">::</span><span class="na">create</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">setHosts</span><span class="p">(</span><span class="nv">$elastic_host_info</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">build</span><span class="p">();</span>

        <span class="nv">$searchParams</span><span class="p">[</span><span class="s1">'index'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'screening-room-index'</span><span class="p">;</span> <span class="c1">// which index to search</span>
        <span class="nv">$searchParams</span><span class="p">[</span><span class="s1">'body'</span><span class="p">][</span><span class="s1">'query'</span><span class="p">][</span><span class="s1">'simple_query_string'</span><span class="p">][</span><span class="s1">'query'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$searchTerm</span><span class="p">;</span> <span class="c1">// what to search for</span>

        <span class="k">return</span> <span class="nv">$elasticSearchClient</span><span class="o">-&gt;</span><span class="na">search</span><span class="p">(</span><span class="nv">$searchParams</span><span class="p">);</span>
    <span class="p">}</span></code></pre></figure> </p> <p>In the doSearch() function, we initialize an Elasticsearch client (using the values stored in the .env file) and then we prepare a simple query string query and return the results.</p> <p>At this point, your SearchController class should look like this:</p> <p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="c1"># search-app/src/Controller/SearchController.php</span>
<span class="kn">namespace</span> <span class="nn">App\Controller</span><span class="p">;</span>

<span class="kn">use</span> <span class="nn">Elasticsearch\ClientBuilder</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Symfony\Bundle\FrameworkBundle\Controller\AbstractController</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Symfony\Component\HttpFoundation\Request</span><span class="p">;</span>
<span class="kn">use</span> <span class="nn">Symfony\Component\Routing\Annotation\Route</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">SearchController</span> <span class="k">extends</span> <span class="nx">AbstractController</span>
<span class="p">{</span>
    <span class="cd">/**
     * @Route("/")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">index</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$searchTerm</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">query</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'query'</span><span class="p">);</span>
        <span class="nv">$searchResults</span> <span class="o">=</span> <span class="p">[];</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$searchTerm</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$queryResponse</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">doSearch</span><span class="p">(</span><span class="nv">$searchTerm</span><span class="p">);</span>
            <span class="nv">$searchResults</span> <span class="o">=</span> <span class="nv">$queryResponse</span><span class="p">[</span><span class="s1">'hits'</span><span class="p">][</span><span class="s1">'hits'</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">'search-app.html.twig'</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'searchTerm'</span> <span class="o">=&gt;</span> <span class="nv">$searchTerm</span><span class="p">,</span>
            <span class="s1">'searchResults'</span> <span class="o">=&gt;</span> <span class="nv">$searchResults</span>
        <span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">doSearch</span><span class="p">(</span><span class="nv">$searchTerm</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$elastic_host_info</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nv">$_ENV</span><span class="p">[</span><span class="s1">'ELASTIC_HOST'</span><span class="p">],</span>
            <span class="nv">$_ENV</span><span class="p">[</span><span class="s1">'ELASTIC_PORT'</span><span class="p">]</span>
        <span class="p">];</span>

        <span class="nv">$elasticSearchClient</span> <span class="o">=</span> <span class="nx">ClientBuilder</span><span class="o">::</span><span class="na">create</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">setHosts</span><span class="p">(</span><span class="nv">$elastic_host_info</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">build</span><span class="p">();</span>

        <span class="nv">$searchParams</span><span class="p">[</span><span class="s1">'index'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'screening-room-index'</span><span class="p">;</span> <span class="c1">// which index to search</span>
        <span class="nv">$searchParams</span><span class="p">[</span><span class="s1">'body'</span><span class="p">][</span><span class="s1">'query'</span><span class="p">][</span><span class="s1">'simple_query_string'</span><span class="p">][</span><span class="s1">'query'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$searchTerm</span><span class="p">;</span> <span class="c1">// what to search for</span>

        <span class="k">return</span> <span class="nv">$elasticSearchClient</span><span class="o">-&gt;</span><span class="na">search</span><span class="p">(</span><span class="nv">$searchParams</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> </p> <p>You can find the search-app twig template in search-app/templates/search-app.html.twig.</p> <h3 id="lets-search"> <a href="#lets-search" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Letâ€™s search! </h3> <p>Now we should be ready to test our app. Open this URL in your browser http://localhost:8080/public/. You should see a search bar. Type a search term and hit Enter. Depending on the search term, you should get results like the ones below: </p> <p> <figure> <img src="/code4lib2020-get-results-es/assets/images/search-results.png" alt="Image displays an example of a search result" /> </figure> </p> <hr /> <p><a href="/code4lib2020-get-results-es/search-app-1/" class="btn btn-outline">Previous: The search app (part 1)</a> <a href="/code4lib2020-get-results-es/searching-multiple-indexes/" class="btn btn-outline">Next: Searching multiple indexes</a></p> </div> </div> </div> </div> </body> </html>
