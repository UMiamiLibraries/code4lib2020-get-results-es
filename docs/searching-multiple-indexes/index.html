<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Searching multiple indexes - Get Results! with Elasticsearch</title> <link rel="shortcut icon" href="https://umiamilibraries.github.io/code4lib2020-get-results-es/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="https://umiamilibraries.github.io/code4lib2020-get-results-es/assets/css/just-the-docs.css"> <script type="text/javascript" src="https://umiamilibraries.github.io/code4lib2020-get-results-es/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="https://umiamilibraries.github.io/code4lib2020-get-results-es/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>Searching multiple indexes | Get Results! with Elasticsearch</title> <meta name="generator" content="Jekyll v3.8.7" /> <meta property="og:title" content="Searching multiple indexes" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Code4Lib 2020 Workshop" /> <meta property="og:description" content="Code4Lib 2020 Workshop" /> <link rel="canonical" href="https://umiamilibraries.github.io/code4lib2020-get-results-es/searching-multiple-indexes/" /> <meta property="og:url" content="https://umiamilibraries.github.io/code4lib2020-get-results-es/searching-multiple-indexes/" /> <meta property="og:site_name" content="Get Results! with Elasticsearch" /> <script type="application/ld+json"> {"description":"Code4Lib 2020 Workshop","@type":"WebPage","url":"https://umiamilibraries.github.io/code4lib2020-get-results-es/searching-multiple-indexes/","headline":"Searching multiple indexes","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="link" viewBox="0 0 16 16"> <title>Link</title> <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path> </symbol> </svg> <div class="page-wrap"> <div class="side-bar"> <div class="site-header"> <a href="https://umiamilibraries.github.io/code4lib2020-get-results-es" class="site-title lh-tight"> Get Results! with Elasticsearch </a> <button class="menu-button fs-3 js-main-nav-trigger" data-text-toggle="Hide" type="button">Menu</button> </div> <div class="navigation main-nav js-main-nav"> <nav role="navigation" aria-label="Main navigation"> <ul class="navigation-list"><li class="navigation-list-item active"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/404.html" class="navigation-list-link"></a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/index.html" class="navigation-list-link">Welcome!</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/computer-setup/" class="navigation-list-link">Computer Setup</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/project-setup/" class="navigation-list-link">Project Setup</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/creating-dockerfile/" class="navigation-list-link">Creating the Dockerfile</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/docker-compose-file/" class="navigation-list-link">The docker-compose file</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/search-app-1/" class="navigation-list-link">The search app (part 1)</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/search-app-2/" class="navigation-list-link">The search app (part 2)</a></li><li class="navigation-list-item active"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/searching-multiple-indexes/" class="navigation-list-link active">Searching multiple indexes</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/dev-tools-console/" class="navigation-list-link">The Dev Tools Console</a></li><li class="navigation-list-item"><a href="https://umiamilibraries.github.io/code4lib2020-get-results-es/useful-links/" class="navigation-list-link">Useful links</a></li></ul> </nav> </div> <footer class="site-footer"> <p class="text-small text-grey-dk-000 mb-4">This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</p> </footer> </div> <div class="main-content-wrap js-main-content" tabindex="0"> <div class="main-content"> <div class="page-header js-page-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search Get Results! with Elasticsearch" aria-label="Search Get Results! with Elasticsearch" autocomplete="off"> <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"><title>Search</title><g fill-rule="nonzero"><path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z"/><path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z"/></g></svg> </div> <div class="js-search-results search-results-wrap"></div> </div> </div> <div class="page"> <div id="main-content" class="page-content" role="main"> <h2 id="searching-multiple-indexes"> <a href="#searching-multiple-indexes" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#link"></use></svg></a> Searching multiple indexes </h2> <p>We can search multiple indexes in Elasticsearch. Let's ingest the <a href="https://www.loc.gov/collections/railroad-maps-1828-to-1900" target="_blank">Railroad Maps, 1828 to 1900 </a> collection from the Library of Congress into the Elasticsearch cluster. Run the following command from the console:</p> <p> <figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="gp">$</span><span class="w"> </span><span class="nb">cd </span>site/wwwroot/
<span class="gp">$</span><span class="w"> </span>php bin/console app:ingest-data <span class="s1">'https://www.loc.gov/collections/railroad-maps-1828-to-1900/?fo=json'</span> <span class="s1">'railroad-maps-index'</span></code></pre></figure> </p> <p>Let's verify that the new index was added by opening http://localhost:9200/_cat/indices?v in your browser. You should get something similar to this:</p> <p> <figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="err">health</span><span class="w"> </span><span class="err">status</span><span class="w"> </span><span class="err">index</span><span class="w">                    </span><span class="err">uuid</span><span class="w">                   </span><span class="err">pri</span><span class="w"> </span><span class="err">rep</span><span class="w"> </span><span class="err">docs.count</span><span class="w"> </span><span class="err">docs.deleted</span><span class="w"> </span><span class="err">store.size</span><span class="w"> </span><span class="err">pri.store.size</span><span class="w">
</span><span class="err">green</span><span class="w">  </span><span class="err">open</span><span class="w">   </span><span class="err">screening-room-index</span><span class="w">     </span><span class="err">Aia</span><span class="mi">1</span><span class="err">GChwQKOizP</span><span class="mi">1</span><span class="err">VOLV</span><span class="mi">46</span><span class="err">w</span><span class="w">   </span><span class="mi">1</span><span class="w">   </span><span class="mi">1</span><span class="w">        </span><span class="mi">366</span><span class="w">            </span><span class="mi">0</span><span class="w">      </span><span class="mf">1.5</span><span class="err">mb</span><span class="w">          </span><span class="mi">798</span><span class="err">kb</span><span class="w">
</span><span class="err">green</span><span class="w">  </span><span class="err">open</span><span class="w">   </span><span class="err">railroad-maps-index</span><span class="w">      </span><span class="err">kaGevN-qTNSRA</span><span class="mi">6</span><span class="err">fWCSVeag</span><span class="w">   </span><span class="mi">1</span><span class="w">   </span><span class="mi">1</span><span class="w">        </span><span class="mi">635</span><span class="w">            </span><span class="mi">0</span><span class="w">      </span><span class="mf">2.1</span><span class="err">mb</span><span class="w">            </span><span class="mi">1</span><span class="err">mb</span></code></pre></figure> </p> <p>We need to tell our app to search in both indexes. We do this by adding the new index to the searchParams array of the doSearch() function in the SearchController class. The function should look like this:</p> <p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="c1"># search-app/src/Controller/SearchController.php</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">doSearch</span><span class="p">(</span><span class="nv">$searchTerm</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$elastic_host_info</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nv">$_ENV</span><span class="p">[</span><span class="s1">'ELASTIC_HOST'</span><span class="p">],</span>
            <span class="nv">$_ENV</span><span class="p">[</span><span class="s1">'ELASTIC_PORT'</span><span class="p">]</span>
        <span class="p">];</span>

        <span class="nv">$elasticSearchClient</span> <span class="o">=</span> <span class="nx">ClientBuilder</span><span class="o">::</span><span class="na">create</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">setHosts</span><span class="p">(</span><span class="nv">$elastic_host_info</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">build</span><span class="p">();</span>

        <span class="nv">$searchParams</span><span class="p">[</span><span class="s1">'index'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'screening-room-index,railroad-maps-index'</span><span class="p">;</span> <span class="c1">// which index to search</span>
        <span class="nv">$searchParams</span><span class="p">[</span><span class="s1">'body'</span><span class="p">][</span><span class="s1">'query'</span><span class="p">][</span><span class="s1">'simple_query_string'</span><span class="p">][</span><span class="s1">'query'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$searchTerm</span><span class="p">;</span> <span class="c1">// what to search for</span>

        <span class="k">return</span> <span class="nv">$elasticSearchClient</span><span class="o">-&gt;</span><span class="na">search</span><span class="p">(</span><span class="nv">$searchParams</span><span class="p">);</span>
    <span class="p">}</span></code></pre></figure> </p> <p>&lt;Let’s also output in our search results the name of the index the result belongs to. Add the following code after line 39 in the search-app.html.twig template</p> <p> <figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="c1"># search-app/src/Controller/SearchController.php</span>
<span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">Index</span> <span class="nx">name</span><span class="o">:</span> <span class="p">{{</span> <span class="nx">result</span><span class="o">.</span><span class="nx">_index</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="nx">p</span><span class="o">&gt;</span></code></pre></figure> </p> <p>Now if you do a search, you should get results from both indexes.</p> <hr /> <p><a href="/code4lib2020-get-results-es/search-app-2/" class="btn btn-outline">Previous: The search app (part 2)</a> <a href="/code4lib2020-get-results-es/dev-tools-console/" class="btn btn-outline">Next: The Dev Tools Console</a></p> </div> </div> </div> </div> </body> </html>
